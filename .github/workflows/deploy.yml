name: Deploy to AWS

on: [push]

jobs:
    build-and-push:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Set up Docker
              uses: docker/setup-qemu-action@v2

            - name: Login to ECR
              uses: aws-actions/amazon-ecr-login@v1
              env:
                  AWS_REGION: ap-northeast-2
                  AWS_DEFAULT_REGION: ap-northeast-2

            - name: Build and push
              uses: docker/build-push-action@v5
              with:
                  context: .
                  push: true
                  tags: |
                      ${{ steps.ecr.outputs.registry }}/my-react-app:latest

    deploy-infra:
        needs: build-and-push
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Set up Terraform
              uses: hashicorp/setup-terraform@v2

            - name: Terraform Init
              run: terraform init

            - name: Terraform Apply
              run: terraform apply -auto-approve
              env:
                  AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY }}
                  AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_KEY }} # [5][8]
