name: Deploy to AWS

on:
    push:
        branches: [main]

env:
    DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
    DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
    IMAGE_NAME: your-dockerhub-username/react-app

jobs:
    build-and-push:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v3

            - name: Docker Build
              run: |
                  docker build -t $IMAGE_NAME:latest .

            - name: Docker Login
              run: echo $DOCKERHUB_TOKEN | docker login -u $DOCKERHUB_USERNAME --password-stdin
              env:
                  DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
                  DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}

            - name: Docker Push
              run: docker push $IMAGE_NAME:latest

    deploy-infra:
        needs: build-and-push
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v3

            - name: Terraform Init
              run: terraform init
              working-directory: ./terraform

            - name: Terraform Apply
              uses: hashicorp/setup-terraform@v2
              with:
                  terraform_version: 1.4.0

            - name: Terraform Apply
              run: terraform apply -auto-approve
              working-directory: ./terraform
              env:
                  AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
                  AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
